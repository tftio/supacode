name: test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
jobs:
  build:
    runs-on: [self-hosted, macOS, ARM64]
    env:
      MISE_HTTP_TIMEOUT: 120
      MISE_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Mise cache
        uses: ./.github/actions/shared-cache
        with:
          path: |
            ~/.local/share/mise
            ~/.cache/mise
          key: ${{ runner.os }}-${{ runner.arch }}-mise-${{ hashFiles('mise.toml') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-mise-
      - run: brew install mise 2>/dev/null
      - run: mise install
      - name: Ghostty cache key
        run: |
          set -euo pipefail
          GHOSTTY_SHA=$(git -C ThirdParty/ghostty rev-parse HEAD)
          printf '%s\n' "GHOSTTY_SHA=$GHOSTTY_SHA" >> "$GITHUB_ENV"
      - name: Ghostty cache
        uses: ./.github/actions/shared-cache
        with:
          path: |
            Frameworks/GhosttyKit.xcframework
            Resources/ghostty
            Resources/terminfo
          key: ${{ runner.os }}-${{ runner.arch }}-ghostty-${{ env.GHOSTTY_SHA }}
      - name: Build ghostty
        run: |
          set -euo pipefail
          make build-ghostty-xcframework
      - run: make lint
      - run: make build-app
      - run: make test
